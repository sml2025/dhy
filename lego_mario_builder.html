<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHYä¹é«˜æ‹¼æ­å›¾ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .specs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border-left: 5px solid #4ecdc4;
        }

        .specs h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .spec-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .spec-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .spec-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        .canvas-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: auto;
            max-height: 800px;
        }

        .canvas {
            border: 2px solid #ddd;
            cursor: crosshair;
            display: block;
            margin: 0 auto;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .color-palette {
            margin-bottom: 25px;
        }

        .color-palette h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .colors {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .color-btn {
            width: 50px;
            height: 50px;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .color-btn::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: #666;
        }

        .materials-list {
            margin-bottom: 25px;
        }

        .materials-list h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .material-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .material-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .material-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .material-count {
            font-weight: bold;
            color: #333;
        }

        .tools {
            margin-bottom: 25px;
        }

        .tools h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .tool-btn {
            width: 100%;
            margin-bottom: 10px;
            text-align: left;
            padding: 10px 15px;
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 0.3;
        }

        .coordinates {
            font-size: 8px;
            fill: #666;
            text-anchor: middle;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
        }

        .instruction-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .instruction-panel h5 {
            color: #856404;
            margin-bottom: 10px;
        }

        .instruction-panel p {
            color: #856404;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="animatedTitle">ğŸ§± DHYä¹é«˜æ‹¼æ­å›¾ç”Ÿæˆå™¨</h1>
            <p>é«˜ç²¾åº¦åƒç´ åŒ–è®¾è®¡ï¼Œå®Œæ•´ææ–™æ¸…å•ä¸æ­å»ºæŒ‡å—</p>
            <p>ç”Ÿæˆæ€»æ•°ç»Ÿè®¡ï¼š<span id="generateCount" style="color: red; font-weight: bold;">000000000</span></p>
        </div>

        <div class="specs">
            <h3>ğŸ“ é¡¹ç›®è§„æ ¼ï¼ˆå¯è‡ªå®šä¹‰ï¼‰</h3>
            <div class="specs-grid">
                <div class="spec-item">
                    <div class="spec-label">æ€»ä½“å°ºå¯¸ (mm)</div>
                    <div class="spec-inputs">
                        <input type="number" id="totalWidth" value="1000" min="100" max="5000" onchange="updateSpecs()"> Ã—
                        <input type="number" id="totalHeight" value="1500" min="100" max="5000" onchange="updateSpecs()">
                    </div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">ä¹é«˜æ¨¡å—å°ºå¯¸ (mm)</div>
                    <div class="spec-inputs">
                        <input type="number" id="moduleWidth" value="15.8" min="5" max="50" step="0.1" onchange="updateSpecs()"> Ã—
                        <input type="number" id="moduleHeight" value="15.8" min="5" max="50" step="0.1" onchange="updateSpecs()">
                    </div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">ç½‘æ ¼æ•°é‡</div>
                    <div class="spec-value" id="gridSize">63Ã—95æ ¼</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">æ€»ä¹é«˜æ•°é‡</div>
                    <div class="spec-value" id="totalBricks">5,985å—</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <input type="file" id="imageInput" accept="image/*" class="btn" style="padding:10px 14px;background:#fff;border:1px solid #ddd;color:#333;">
            <button class="btn btn-primary" onclick="generateFromImage()">ğŸ–¼ï¸ ä»å›¾ç‰‡ç”Ÿæˆä¹é«˜åº•å›¾</button>
            <button class="btn btn-secondary" onclick="clearCanvas()">ğŸ—‘ï¸ æ¸…ç©ºç”»å¸ƒ</button>
            <button class="btn btn-success" onclick="generateInstructions()">ğŸ“‹ ç”Ÿæˆæ­å»ºæŒ‡å—</button>
            <button class="btn btn-primary" onclick="exportDesign(true)">ğŸ’¾ å¯¼å‡ºé«˜æ¸…æ‹¼æ­å›¾</button>
            <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#333">
                <input type="checkbox" id="toggleGridCbx" checked onchange="toggleGrid()"> æ˜¾ç¤ºç½‘æ ¼
            </label>
            <label style="display:flex;align-items:center;gap:6px;font-size:14px;color:#333">
                <input type="checkbox" id="toggleNumCbx" checked onchange="toggleNumbers()"> æ ‡æ³¨åºå·
            </label>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <div class="instruction-panel">
            <h5>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h5>
            <p>1. ç‚¹å‡»"ç”Ÿæˆä¹é«˜å›¾æ¡ˆ"åˆ›å»ºåƒç´ åŒ–ä¹é«˜å›¾æ¡ˆ<br>
               2. ä½¿ç”¨å³ä¾§è°ƒè‰²æ¿é€‰æ‹©é¢œè‰²ï¼Œç‚¹å‡»ç½‘æ ¼è¿›è¡Œç»˜åˆ¶<br>
               3. æŸ¥çœ‹ææ–™æ¸…å•äº†è§£æ‰€éœ€ä¹é«˜æ•°é‡<br>
               4. ç”Ÿæˆæ­å»ºæŒ‡å—è·å¾—è¯¦ç»†æ‹¼æ­æ­¥éª¤</p>
        </div>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="legoCanvas" class="canvas" width="630" height="950"></canvas>
            </div>

            <div class="sidebar">
                <div class="color-palette">
                    <h4>ğŸ¨ è°ƒè‰²æ¿</h4>
                    <div class="colors" id="colorPalette">
                        <!-- é¢œè‰²å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="materials-list">
                    <h4>ğŸ§± ææ–™æ¸…å•</h4>
                    <div id="materialsList">
                        <!-- ææ–™æ¸…å•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="tools">
                    <h4>ğŸ”§ å·¥å…·</h4>
                    <button class="btn tool-btn btn-primary" id="showGridBtn" onclick="showGridNumbers()">æ˜¾ç¤ºæ ¼å­ç¼–å·</button>
                    <button class="btn tool-btn btn-secondary" id="buildGuideBtn" onclick="generateBuildingGuide()">ç”Ÿæˆæ‹¼æ­é¡ºåº</button>
                    <button class="btn tool-btn btn-success" id="calcCostBtn" onclick="calculateCost()">è®¡ç®—ææ–™æˆæœ¬</button>
-                    <div id="costDisplay" style="margin-top: 10px; font-weight: bold; color: #333;"></div>
+                    <div id="costDisplay" style="display:inline-block; margin-left:12px; font-weight: bold; color: #333; vertical-align: middle;"></div>
                 </div>
             </div>
         </div>
     </div>
 
     <script>
        // å…¨å±€å˜é‡
        const canvas = document.getElementById('legoCanvas');
        const ctx = canvas.getContext('2d');
        
        // å¯å˜ç½‘æ ¼è§„æ ¼
        let TOTAL_W_MM = 1000, TOTAL_H_MM = 1500, MOD_W_MM = 15.8, MOD_H_MM = 15.8;
        let GRID_WIDTH = Math.round(TOTAL_W_MM / MOD_W_MM);
        let GRID_HEIGHT = Math.round(TOTAL_H_MM / MOD_H_MM);
        const CELL_SIZE = 10;
        let showNumbers = true;

        // è¡¥å……ï¼šä¹é«˜é¢œè‰²è°ƒè‰²æ¿ä¸å…¨å±€çŠ¶æ€
        const LEGO_COLORS = {
          'white': '#F4F4F4',
          'black': '#1B2A34',
          'red': '#C91A09',
          'blue': '#0055BF',
          'yellow': '#FFD700',
          'green': '#237841',
          'orange': '#FE8A18',
          'brown': '#582A12',
          'gray': '#9BA19D',
          'pink': '#FEC7ED',
          'purple': '#81007B',
          'lime': '#BBE90B',
          'tan': '#E4CD9E',
          'darkgray': '#6C6E68'
        };
        let selectedColor = 'red';
        let gridData = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill('white'));
        let showGrid = true;

        // === ç”Ÿæˆæ€»æ•°ç»Ÿè®¡ï¼ˆ9ä½ï¼Œçº¢è‰²ï¼‰ ===
        const COUNT_KEY = 'dhy_total_generate_count';
        function format9(n){
            const s = String(n);
            return s.length>=9 ? s.slice(-9) : '0'.repeat(9 - s.length) + s;
        }
        function getCount(){
            const v = parseInt(localStorage.getItem(COUNT_KEY)||'0',10);
            return isNaN(v)?0:v;
        }
        function setCount(n){
            localStorage.setItem(COUNT_KEY, String(n));
            const el = document.getElementById('generateCount');
            if(el) el.textContent = format9(n);
        }
        function incCount(){ setCount(getCount()+1); }

        // ä»å›¾ç‰‡ç”Ÿæˆ 63Ã—95 ä¹é«˜åº•å›¾
        function generateFromImage(){
          incCount(); // å¢åŠ è®¡æ•°
          const file = document.getElementById('imageInput').files[0];
          if(!file){
            alert('è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡');
            return;
          }
          const img = new Image();
          img.onload = () => {
            // ä½¿ç”¨ç¦»å±canvasæŠŠå›¾ç‰‡ç¼©æ”¾åˆ°63Ã—95åƒç´ 
            const off = document.createElement('canvas');
            off.width = GRID_WIDTH;
            off.height = GRID_HEIGHT;
            const octx = off.getContext('2d');
            octx.imageSmoothingEnabled = false;
            // ä¿æŒæ¯”ä¾‹å±…ä¸­å¡«å……
            const ratio = Math.min(off.width/img.width, off.height/img.height);
            const dw = img.width*ratio;
            const dh = img.height*ratio;
            const dx = (off.width-dw)/2;
            const dy = (off.height-dh)/2;
            octx.fillStyle = '#ffffff';
            octx.fillRect(0,0,off.width,off.height);
            octx.drawImage(img, dx, dy, dw, dh);
            const data = octx.getImageData(0,0,off.width,off.height).data;
            // å†™å…¥gridData
            gridData = Array(GRID_HEIGHT).fill().map(()=>Array(GRID_WIDTH).fill('white'));
            let i = 0;
            for(let y=0;y<GRID_HEIGHT;y++){
              for(let x=0;x<GRID_WIDTH;x++){
                const r = data[i++];
                const g = data[i++];
                const b = data[i++];
                i++; // skip alpha
                const c = nearestLegoColor(r,g,b);
                gridData[y][x] = c;
              }
            }
            drawGrid();
            updateMaterialsList();
            updateProgress();
          };
          img.src = URL.createObjectURL(file);
        }

        function toggleNumbers(){
          showNumbers = document.getElementById('toggleNumCbx').checked;
          drawGrid();
        }

        // ç»˜åˆ¶ç½‘æ ¼ï¼ˆå«åºå·ä¸ç½‘æ ¼çº¿ï¼‰
        function drawGrid(){
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          for (let y = 0; y < GRID_HEIGHT; y++) {
            for (let x = 0; x < GRID_WIDTH; x++) {
              const color = LEGO_COLORS[gridData[y][x]];
              ctx.fillStyle = color;
              ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
              ctx.strokeStyle = '#ddd';
              ctx.lineWidth = 0.5;
              ctx.strokeRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
              if (showNumbers) {
                ctx.fillStyle = '#222';
                ctx.font = '6px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const idx = y * GRID_WIDTH + x + 1; // å…¨å±€åºå·
                ctx.fillText(idx.toString(), x * CELL_SIZE + CELL_SIZE / 2, y * CELL_SIZE + CELL_SIZE / 2);
              }
            }
          }
          if (showGrid) {
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 0.5;
            for (let x = 0; x <= GRID_WIDTH; x++) {
              ctx.beginPath();
              ctx.moveTo(x * CELL_SIZE, 0);
              ctx.lineTo(x * CELL_SIZE, canvas.height);
              ctx.stroke();
            }
            for (let y = 0; y <= GRID_HEIGHT; y++) {
              ctx.beginPath();
              ctx.moveTo(0, y * CELL_SIZE);
              ctx.lineTo(canvas.width, y * CELL_SIZE);
              ctx.stroke();
            }
          }
        }

        // å¯¼å‡ºé«˜æ¸…æ‹¼æ­å›¾ï¼ˆå«æ¯æ ¼åºå·ä¸è¾¹ç¼˜è¡Œåˆ—å·ï¼‰
        function exportDesign(highRes=false){
          incCount(); // å¢åŠ è®¡æ•°
          const scale = highRes ? 40 : CELL_SIZE; // é«˜æ¸…æ¯æ ¼40åƒç´ 
          const w = GRID_WIDTH*scale;
          const h = GRID_HEIGHT*scale;
          const padLeft = 120, padTop = 120, padRight = 420, padBottom = 120;
          const out = document.createElement('canvas');
          out.width = w + padLeft + padRight;
          out.height = h + padTop + padBottom;
          const c = out.getContext('2d');
          c.fillStyle = '#ffffff';
          c.fillRect(0,0,out.width,out.height);
          // æ ‡é¢˜
          c.fillStyle = '#111';
          c.font = 'bold 36px Arial';
          c.fillText('ä¹é«˜æ‹¼æ­å›¾ 63Ã—95ï¼ˆæ¯æ ¼15.8mmï¼‰', padLeft, 60);
          c.font = '20px Arial';
          c.fillText('æ€»ä½“å°ºå¯¸çº¦ 1000Ã—1500mmï¼ˆå«å¾®å°å–æ•´è¯¯å·®ï¼‰', padLeft, 90);

          // ç»˜åˆ¶ä¸»ä½“
          for(let y=0;y<GRID_HEIGHT;y++){
            for(let x=0;x<GRID_WIDTH;x++){
              c.fillStyle = LEGO_COLORS[gridData[y][x]];
              const x1 = padLeft + x*scale;
              const y1 = padTop + y*scale;
              c.fillRect(x1, y1, scale, scale);
              c.strokeStyle = '#cccccc';
              c.lineWidth = 1;
              c.strokeRect(x1, y1, scale, scale);
              // åºå·
              if(showNumbers){
                c.fillStyle = '#111';
                c.font = `${Math.max(12, Math.floor(scale*0.28))}px Arial`;
                c.textAlign = 'center';
                c.textBaseline = 'middle';
                const idx = y*GRID_WIDTH + x + 1;
                c.fillText(idx.toString(), x1 + scale/2, y1 + scale/2);
              }
            }
          }
          // è¾¹ç¼˜è¡Œåˆ—æ ‡æ³¨
          c.fillStyle = '#333';
          c.font = '16px Arial';
          c.textAlign = 'center';
          for(let x=0;x<GRID_WIDTH;x++){
            const cx = padLeft + x*scale + scale/2;
            c.fillText((x+1).toString(), cx, padTop-20);
            c.fillText((x+1).toString(), cx, padTop+h+20);
          }
          c.textAlign = 'right';
          for(let y=0;y<GRID_HEIGHT;y++){
            const cy = padTop + y*scale + scale/2;
            c.fillText((y+1).toString(), padLeft-10, cy);
            c.textAlign = 'left';
            c.fillText((y+1).toString(), padLeft+w+10, cy);
            c.textAlign = 'right';
          }

          // ææ–™æ¸…å•æ±‡æ€»
          const materials = {};
          for(let y=0;y<GRID_HEIGHT;y++){
            for(let x=0;x<GRID_WIDTH;x++){
              const color = gridData[y][x];
              materials[color] = (materials[color]||0)+1;
            }
          }
          let yText = padTop;
          c.fillStyle = '#111';
          c.font = 'bold 24px Arial';
          c.fillText('ææ–™æ¸…å•ï¼ˆä¸­æ–‡ç‰ˆï¼‰', padLeft+w+40, yText);
          yText += 30;
          c.font = '18px Arial';
          const namesZH = {white:'ç™½è‰²',black:'é»‘è‰²',red:'çº¢è‰²',blue:'è“è‰²',yellow:'é»„è‰²',green:'ç»¿è‰²',orange:'æ©™è‰²',brown:'æ£•è‰²',gray:'ç°è‰²',pink:'ç²‰è‰²',purple:'ç´«è‰²',lime:'æŸ æª¬ç»¿',tan:'æ£•è¤è‰²',darkgray:'æ·±ç°'};
          Object.entries(materials).sort((a,b)=>b[1]-a[1]).forEach(([color,count])=>{
            if(count>0){
              c.fillStyle = LEGO_COLORS[color];
              c.fillRect(padLeft+w+40, yText-14, 20, 20);
              c.strokeStyle = '#333';
              c.strokeRect(padLeft+w+40, yText-14, 20, 20);
              c.fillStyle = '#111';
              c.fillText(`${namesZH[color]||color}ï¼š${count} å—`, padLeft+w+70, yText);
              yText += 26;
            }
          });

          const link = document.createElement('a');
          link.download = highRes ? 'ä¹é«˜é«˜æ¸…æ‹¼æ­å›¾.png' : 'ä¹é«˜è®¾è®¡å›¾.png';
          link.href = out.toDataURL('image/png');
          link.click();
        }

        function generateMarioPattern() {
            // åˆ›å»ºé©¬é‡Œå¥¥åƒç´ å›¾æ¡ˆ
            const mario = [
                "wwwwwrrrrrrwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwrrrrrrrrrrwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwbbbtoootbbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwbbtttooottbbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwbbttoottottbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwbbtttoottttbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwbttttttttbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwwbbbttbbbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwwbbbttbbbwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww",
                "wwwttttttttttwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww"
            ];
            
            // è½¬æ¢é¢œè‰²ç¼–ç 
            const colorMap = {
                'w': 'white',
                'r': 'red',
                'b': 'brown',
                't': 'tan',
                'o': 'orange'
            };
            
            // æ¸…ç©ºç½‘æ ¼
            gridData = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill('white'));
            
            // åœ¨ç½‘æ ¼ä¸­å¿ƒç»˜åˆ¶é©¬é‡Œå¥¥
            const startY = Math.floor((GRID_HEIGHT - mario.length) / 2);
            const startX = Math.floor((GRID_WIDTH - mario[0].length) / 2);
            
            for (let y = 0; y < mario.length; y++) {
                for (let x = 0; x < mario[y].length; x++) {
                    const gridY = startY + y;
                    const gridX = startX + x;
                    
                    if (gridY >= 0 && gridY < GRID_HEIGHT && gridX >= 0 && gridX < GRID_WIDTH) {
                        const colorCode = mario[y][x];
                        gridData[gridY][gridX] = colorMap[colorCode] || 'white';
                    }
                }
            }
            
            drawGrid();
            updateMaterialsList();
            updateProgress();
        }

        function updateMaterialsList() {
            const materials = {};
            
            // ç»Ÿè®¡æ¯ç§é¢œè‰²çš„æ•°é‡
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const color = gridData[y][x];
                    materials[color] = (materials[color] || 0) + 1;
                }
            }
            
            // ç”Ÿæˆææ–™æ¸…å•HTML
            const materialsList = document.getElementById('materialsList');
            materialsList.innerHTML = '';
            
            Object.entries(materials).forEach(([color, count]) => {
                if (count > 0) {
                    const item = document.createElement('div');
                    item.className = 'material-item';
                    item.innerHTML = `
                        <div class="material-info">
                            <div class="material-color" style="background-color: ${LEGO_COLORS[color]}"></div>
                            <span>${getColorName(color)}</span>
                        </div>
                        <div class="material-count">${count}å—</div>
                    `;
                    materialsList.appendChild(item);
                }
            });

            // æ›´æ–°æˆæœ¬æ˜¾ç¤º
            updateCostDisplay();
        }

        function updateCostDisplay() {
            const materials = {};
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const color = gridData[y][x];
                    materials[color] = (materials[color] || 0) + 1;
                }
            }
            
            let totalCost = 0;
            const pricePerBrick = 0.5;
            
            Object.entries(materials).forEach(([color, count]) => {
                if (color !== 'white') {
                    totalCost += count * pricePerBrick;
                }
            });
            
            const costDisplay = document.getElementById('costDisplay');
            if (costDisplay) {
                costDisplay.innerHTML = `é¢„ä¼°æˆæœ¬ï¼š<span style="color: #e74c3c; font-size: 18px;">${totalCost.toFixed(2)}å…ƒ</span>`;
            }
        }

        function getColorName(color) {
            const names = {
                'white': 'ç™½è‰²',
                'black': 'é»‘è‰²',
                'red': 'çº¢è‰²',
                'blue': 'è“è‰²',
                'yellow': 'é»„è‰²',
                'green': 'ç»¿è‰²',
                'orange': 'æ©™è‰²',
                'brown': 'æ£•è‰²',
                'gray': 'ç°è‰²',
                'pink': 'ç²‰è‰²',
                'purple': 'ç´«è‰²',
                'lime': 'æŸ æª¬ç»¿',
                'tan': 'æ£•è¤è‰²',
                'darkgray': 'æ·±ç°è‰²'
            };
            return names[color] || color;
        }

        function updateProgress() {
            const totalCells = GRID_WIDTH * GRID_HEIGHT;
            let filledCells = 0;
            
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    if (gridData[y][x] !== 'white') {
                        filledCells++;
                    }
                }
            }
            
            const progress = (filledCells / totalCells) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        function clearCanvas() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ')) {
                gridData = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill('white'));
                drawGrid();
                updateMaterialsList();
                updateProgress();
            }
        }

        function toggleGrid() {
            showGrid = !showGrid;
            drawGrid();
        }

        function generateInstructions() {
            incCount(); // å¢åŠ è®¡æ•°
            const instructions = generateDetailedInstructions();
            downloadInstructions(instructions);
        }

        function generateDetailedInstructions() {
            let instructions = "ä¹é«˜æ‹¼æ­æŒ‡å—\n";
            instructions += "==================\n\n";
            instructions += "é¡¹ç›®è§„æ ¼ï¼š\n";
            instructions += `- æ€»ä½“å°ºå¯¸ï¼š${TOTAL_W_MM}mm Ã— ${TOTAL_H_MM}mm\n`;
            instructions += `- ä¹é«˜æ¨¡å—å°ºå¯¸ï¼š${MOD_W_MM}mm Ã— ${MOD_H_MM}mm\n`;
            instructions += `- ç½‘æ ¼æ•°é‡ï¼š${GRID_WIDTH}åˆ— Ã— ${GRID_HEIGHT}è¡Œ\n`;
            instructions += `- æ€»ä¹é«˜æ•°é‡ï¼š${(GRID_WIDTH*GRID_HEIGHT).toLocaleString()}å—\n\n`;
            
            instructions += "ææ–™æ¸…å•ï¼š\n";
            instructions += "----------\n";
            
            const materials = {};
            for (let y = 0; y < GRID_HEIGHT; y++) {
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const color = gridData[y][x];
                    materials[color] = (materials[color] || 0) + 1;
                }
            }
            
            // è®¡ç®—æˆæœ¬
            let totalCost = 0;
            const pricePerBrick = 0.5;
            
            Object.entries(materials).forEach(([color, count]) => {
                if (count > 0) {
                    instructions += `- ${getColorName(color)}ï¼š${count}å—\n`;
                    if (color !== 'white') {
                        totalCost += count * pricePerBrick;
                    }
                }
            });
            
            instructions += `\nææ–™æˆæœ¬ï¼š\n`;
            instructions += `----------\n`;
            instructions += `é¢„ä¼°æ€»æˆæœ¬ï¼šçº¦${totalCost.toFixed(2)}å…ƒ\n`;
            instructions += `ï¼ˆæŒ‰æ¯å—ä¹é«˜${pricePerBrick}å…ƒè®¡ç®—ï¼Œä¸å«ç™½è‰²åº•è‰²ï¼‰\n\n`;
            
            instructions += "\næ‹¼æ­æ­¥éª¤ï¼š\n";
            instructions += "----------\n";
            
            for (let y = 0; y < GRID_HEIGHT; y++) {
                instructions += `ç¬¬${y + 1}è¡Œï¼š`;
                for (let x = 0; x < GRID_WIDTH; x++) {
                    const color = gridData[y][x];
                    instructions += `${x + 1}(${getColorName(color)[0]}) `;
                }
                instructions += "\n";
            }
            
            return instructions;
        }

        function downloadInstructions(content) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ä¹é«˜æ‹¼æ­æŒ‡å—.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é‡åŒ–åˆ°æœ€è¿‘çš„ä¹é«˜é¢œè‰²
        function hexToRgb(hex){
          const v = hex.replace('#','');
          return {r:parseInt(v.substring(0,2),16),g:parseInt(v.substring(2,4),16),b:parseInt(v.substring(4,6),16)};
        }
        const LEGO_RGB = Object.fromEntries(Object.entries(LEGO_COLORS).map(([k,v])=>[k,hexToRgb(v)]));
        function colorDistance(a,b){
          return Math.sqrt((a.r-b.r)**2+(a.g-b.g)**2+(a.b-b.b)**2);
        }
        function nearestLegoColor(r,g,b){
          let bestColor = 'white';
          let bestDist = Infinity;
          for(const [name, rgb] of Object.entries(LEGO_RGB)){
            const d = colorDistance({r,g,b}, rgb);
            if(d < bestDist){ bestDist = d; bestColor = name; }
          }
          return bestColor;
        }

        // åˆå§‹åŒ–åº”ç”¨
        function init(){
          // æ„å»ºè°ƒè‰²æ¿
          const palette = document.getElementById('colorPalette');
          palette.innerHTML = '';
          Object.entries(LEGO_COLORS).forEach(([name, hex])=>{
            const btn = document.createElement('button');
            btn.className = 'color-btn';
            btn.style.backgroundColor = hex;
            btn.title = name;
            btn.addEventListener('click', ()=>{
              selectedColor = name;
              [...palette.children].forEach(el=>el.classList.remove('active'));
              btn.classList.add('active');
            });
            palette.appendChild(btn);
          });
          palette.firstChild && palette.firstChild.classList.add('active');

          // ç”»å¸ƒç»˜åˆ¶ä¸äº¤äº’
          canvas.addEventListener('click', (e)=>{
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / CELL_SIZE);
            const y = Math.floor((e.clientY - rect.top) / CELL_SIZE);
            if(x>=0 && x<GRID_WIDTH && y>=0 && y<GRID_HEIGHT){
              gridData[y][x] = selectedColor;
              drawGrid();
              updateMaterialsList();
              updateProgress();
            }
          });

          // åˆå§‹ç»˜åˆ¶
          drawGrid();
          updateMaterialsList();
          updateProgress();
        }

        // åŠ¨æ€æ›´æ–°ç½‘æ ¼è§„æ ¼çš„å‡½æ•°
        function updateSpecs(){
            const tw = parseFloat(document.getElementById('totalWidth').value || '1000');
            const th = parseFloat(document.getElementById('totalHeight').value || '1500');
            const mw = parseFloat(document.getElementById('moduleWidth').value || '15.8');
            const mh = parseFloat(document.getElementById('moduleHeight').value || '15.8');
            
            if(mw<=0 || mh<=0 || tw<=0 || th<=0){
                alert('å°ºå¯¸å¿…é¡»ä¸ºæ­£æ•°');
                return;
            }
            
            TOTAL_W_MM = tw; TOTAL_H_MM = th; MOD_W_MM = mw; MOD_H_MM = mh;
            GRID_WIDTH = Math.max(1, Math.round(TOTAL_W_MM / MOD_W_MM));
            GRID_HEIGHT = Math.max(1, Math.round(TOTAL_H_MM / MOD_H_MM));
            
            // é‡æ–°åˆå§‹åŒ–æ•°æ®ä¸ç”»å¸ƒå°ºå¯¸
            gridData = Array(GRID_HEIGHT).fill().map(()=>Array(GRID_WIDTH).fill('white'));
            canvas.width = GRID_WIDTH * CELL_SIZE;
            canvas.height = GRID_HEIGHT * CELL_SIZE;
            
            // æ›´æ–°è§„æ ¼æ˜¾ç¤º
            document.getElementById('gridSize').textContent = `${GRID_WIDTH}Ã—${GRID_HEIGHT}æ ¼`;
            document.getElementById('totalBricks').textContent = `${(GRID_WIDTH*GRID_HEIGHT).toLocaleString()}å—`;
            
            // é‡æ–°ç»˜åˆ¶
            drawGrid();
            updateMaterialsList();
            updateProgress();
        }

        function showGridNumbers() {
            // æŒ‰é’®é€‰ä¸­æ•ˆæœ
            toggleButtonActive('showGridBtn');
            alert('ç½‘æ ¼ç¼–å·åŠŸèƒ½ï¼š\nè¡Œç¼–å·ï¼š1-95ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰\nåˆ—ç¼–å·ï¼š1-63ï¼ˆä»å·¦åˆ°å³ï¼‰\næ ¼å­ç¼–å·ï¼šè¡Œå·-åˆ—å·ï¼ˆå¦‚ï¼š1-1, 1-2...ï¼‰');
        }

        function generateBuildingGuide() {
            // æŒ‰é’®é€‰ä¸­æ•ˆæœ
            toggleButtonActive('buildGuideBtn');
            alert('æ‹¼æ­é¡ºåºå»ºè®®ï¼š\n1. ä»åº•éƒ¨å¼€å§‹å‘ä¸Šæ‹¼æ­\n2. æŒ‰è¡Œä»å·¦åˆ°å³ä¾æ¬¡æ”¾ç½®\n3. å…ˆå®Œæˆè½®å»“å†å¡«å……å†…éƒ¨\n4. ç›¸åŒé¢œè‰²çš„åŒºåŸŸå¯ä»¥æ‰¹é‡å¤„ç†');
        }

        function calculateCost() {
            // æŒ‰é’®é€‰ä¸­æ•ˆæœ
            toggleButtonActive('calcCostBtn');
            updateCostDisplay();
        }

        function toggleButtonActive(buttonId) {
            // æ¸…é™¤æ‰€æœ‰å·¥å…·æŒ‰é’®çš„activeçŠ¶æ€
            ['showGridBtn', 'buildGuideBtn', 'calcCostBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove('btn-active');
                    btn.style.backgroundColor = '';
                    btn.style.transform = '';
                    btn.style.boxShadow = '';
                }
            });
            
            // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºactiveçŠ¶æ€
            const activeBtn = document.getElementById(buttonId);
            if (activeBtn) {
                activeBtn.classList.add('btn-active');
                activeBtn.style.backgroundColor = '#2980b9';
                activeBtn.style.transform = 'scale(1.05)';
                activeBtn.style.boxShadow = '0 4px 12px rgba(52, 152, 219, 0.4)';
                activeBtn.style.transition = 'all 0.2s ease';
                
                // 3ç§’åæ¢å¤æ­£å¸¸çŠ¶æ€
                setTimeout(() => {
                    activeBtn.classList.remove('btn-active');
                    activeBtn.style.backgroundColor = '';
                    activeBtn.style.transform = '';
                    activeBtn.style.boxShadow = '';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–è®¡æ•°æ˜¾ç¤º
        window.addEventListener('DOMContentLoaded', ()=>{
            setCount(getCount());
            document.getElementById('gridSize').textContent = `${GRID_WIDTH}Ã—${GRID_HEIGHT}æ ¼`;
            document.getElementById('totalBricks').textContent = `${(GRID_WIDTH*GRID_HEIGHT).toLocaleString()}å—`;
        });

        // ==== å½©è‰²æ¸å˜æ³¢æµªåŠ¨ç”»ï¼ˆæ ‡é¢˜ä¸ç‰ˆæƒï¼‰====
        function setupWavyRainbow(elementId, opts={}){
          const el = document.getElementById(elementId);
          if(!el) return;
          const text = el.textContent;
          el.textContent = '';
          const frag = document.createDocumentFragment();
          const spans = [];
          for(let i=0;i<text.length;i++){
            const ch = text[i] === ' ' ? '\u00A0' : text[i];
            const sp = document.createElement('span');
            sp.textContent = ch;
            sp.style.display = 'inline-block';
            sp.style.willChange = 'transform,color,filter';
            spans.push(sp);
            frag.appendChild(sp);
          }
          el.appendChild(frag);
          const amplitude = opts.amplitude ?? 6; // å‚ç›´æ‘†åŠ¨å¹…åº¦(px)
          const phaseStep = opts.phaseStep ?? 0.5; // ç›¸ä½æ­¥è¿›(æ¯å­—ç›¸ä½å·®)
          const hueStep = opts.hueStep ?? 18; // ç›¸é‚»å­—ç¬¦è‰²ç›¸å·®
          const waveSpeed = opts.waveSpeed ?? 0.005; // æ³¢é€Ÿ
          const hueSpeed = opts.hueSpeed ?? 0.03; // è‰²ç›¸å˜åŒ–é€Ÿåº¦
          function tick(t){
            for(let i=0;i<spans.length;i++){
              const sp = spans[i];
              const y = Math.sin(t*waveSpeed + i*phaseStep) * amplitude;
              const hue = (t*hueSpeed + i*hueStep) % 360;
              sp.style.transform = `translateY(${y.toFixed(2)}px)`;
              sp.style.color = `hsl(${hue.toFixed(1)}, 90%, 55%)`;
            }
            requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        }

        window.addEventListener('DOMContentLoaded', () => {
          // æ ‡é¢˜ï¼šå¹…åº¦æ›´å¤§ï¼Œé€Ÿåº¦ç•¥å¿«
          setupWavyRainbow('animatedTitle', { amplitude: 7, phaseStep: 0.55, hueStep: 20, waveSpeed: 0.007, hueSpeed: 0.05 });
          // é¡µè„šï¼šå¹…åº¦æ›´å°ï¼Œé€Ÿåº¦æ›´æŸ”å’Œ
          setupWavyRainbow('animatedFooter', { amplitude: 3, phaseStep: 0.5, hueStep: 16, waveSpeed: 0.006, hueSpeed: 0.04 });
        });

        init();
    </script>
    
    <footer style="text-align: center; padding: 20px; margin-top: 30px; border-top: 1px solid #eee; color: #666; font-size: 12px;" id="animatedFooter">
        Â©è‘£æ´ªå®‡å·¥ä½œå®¤ 2025. ä¿ç•™æ‰€æœ‰æƒåˆ©.
    </footer>
        </div>
    </div>
</body>
</html>